# HighLoad

The project was developed as part of the Technopark's high-load systems course.

---

### Тема проекта:

Социальная сеть - TikTok.

### Целевая аудитория сервиса:

- 600 млн пользователей в Индии, США, Турции, России и других странах.
- Российская аудитория ~ 18 млн

### MVP проекта:

1. Авторизация, регистрация, профиль пользователя;
2. Просмотр видео;
3. Поиск.

### Расчет нагрузки (Россия):

#### Исходные данные:

- Среднее время, которое проводит пользователь в приложении за день: 45 мин;
    - 80%: просмотр видео,
    - 15% поиск в рекоммендациях,
    - 5% другое.
- Среднее число заходов в приложение за день: 7;
- Максимальная длина ролика: 1 минута;
- Минимальная длина ролика: 15 секунд;
- Максимальный размер видео: 75Mb (android), 250Mb (ios);
- Число ежедневных просмотров видео: 666 млн;
- Число ежедневных загрузок видео: 666 тыс;
- Среднее число хэштегов в видео: 4;

Источник:
  - https://news.cpa.ru/tiktok-showed-audience-statistics/
  - https://rusability.ru/articles/Heshtegi-dlya-Tik-Tok-kak-podobrat,-ispolzovat-i-prodvigatsya-bistree-konkurentov/5fd296ad2dda593c3483efc4

#### Расчеты:

- Средний объем трафика для одного пользователя: 16 Mb/min (Источник: https://www.quora.com/What-uses-more-data-watching-YouTube-videos-for-an-hour-or-TikTok-videos-for-an-hour)
    - 12.8 Mb/min: загрузка видео-контента
    - 2.4 Mb/min: поиск в рекоммендациях (гифки вместо видео)
    - 0.8 Mb/min: другие операции
- Средний объем выгружаемого на сервер видео-контента: (75+250)/2 = 162.5 Mb;
- Скорость выгрузки контента зависит от скорости интернет соединения (~15Mb/sec) и в среднем составляет: 11 сек;

Будем считать, что пиковое число обращений к серверу за 1 секунду будет равно 50% от общего количества пользователей. А
число пользователей, загружающих в эту секунду видео - 0.1% от текущих.

`Общий объем трафика за 1 секунду в пиковой нагрузке для:`

- Просмотра видео-контента: (12.8 Mb * 9 * 10 ^ 6) / 60  ~ **1.83 Tb/s**
- Выгрузки на сервер видео-контента: (162.5 Mb * 9 * 10 ^ 3) / 60  ~ **0.02 Tb/s** ??
- Поиск в рекоммедациях: (2.4 Mb * 9 * 10 ^ 6) / 60 ~ **0.34 Tb/s**
- Другие операции (бизнес-логика): (0.8 Mb * 9 * 10 ^ 6) / 60 ~ **0.11 Tb/s**

`Результирующие порядки RPS по типам запросов при средней загруженности серверов`

    Запросы за видео: 666 * 10^6 / (24 * 3600) ~= 7700 RPS
    Запросы за гифками: 666 * 10^6 * 0.15 / (24 * 3600) ~= 1150 RPS
    Запросы бизнес-логики: 666 * 10^6 * 0.5 / (24 * 3600) ~= 385 RPS

### Логическая схема БД:

---
![Иллюстрация к проекту](https://raw.githubusercontent.com/H-b-IO-T-O-H/HighLoad/main/subd_sheme/subd_logic.png)

### Физическая схема БД:

Размер uuid - 16 bytes

    videos:
      video_id(16) + title(150) + author_name(24) + autor_id(16) + duration(4) + likes_cnt(8) + audio_file_title(50) + path_to_video_file(128) + file_prefix(16) = 412 bytes
      
    Количество загружаемых видео: 20 * 10^6 / month, на первый год потребуется 12 * 20 * 10^6 * 412 ~ 92.1 Gb для хранения в бд и --- в файловом хранилище
    users:
      user_id(16) + name(20) + username(24) + email(128) + phone(11) + password(128) + total_likes_cnt(8) + followers_cnt(8) + following_cnt(8) = 351 bytes
      Количество пользователей в России: 18 * 10^6, потребуется 18 * 10^6 * 351 ~ 5.9 Gb
    
    video_preview_gifs:
    
    followers:
      follower_id(16) + user_id(16) + follower_name(24) = 56 bytes
      Будем считать только Российский сегмент без подписок на иностранных авторов: 
      Количество пользователей в России: 18 * 10^6, потребуется 18 * 10^6 * 56 ~ 0,94 Gb
    
    hashtags:
      hashtag_id(16) + hashtag(100) + followers_cnt(8) + is_trend(1) ~ 125 bytes
      В среднем для видео генерируется 4 хэштега. Для Российского сегмента потребуется:
      12 * 20 * 4 * 10^6 * 125 ~ 111 Gb

    recommendations:
      Предположим, рекомендации пользователя определяются на основании 10 последних просмотренных видео и 5 наиболее популярных хэштегов.
      recommendation_id(16) + user_id(16) + favourites_videos_id(16 * 10) +  favourites_hashtags_id(16 * 5) + average_video_duration(4) = 356 bytes
      18 * 10^6 * 356 ~ 5.97 Gb
      
    
  
|Сущность|Объем памяти на год работы, Гб|
| -------------  | :-------------:  |
|Users|5.9|
|Recommendations|5.97|
|Videos|92.1|
|Gifs (video preview)| - |
|Hashtags|111|
|Followers|0.94|

### Выбор СУБД

Данные пользователей, информацию о видео, подписках и рекоммендациях будут храниться в PostgreSQL, как в хорошо зарекомендовавшей себя реляционной БД, котарая
поддерживает все необходимые средства для ораганизации распределенных систем.
Данные о сессии будут храниться в Redis из-за его высокой скорости работы. 

### Шардирование и репликация

- Профили пользователей будем шардировать по user_id.
- Видео и связанную с ним preview-гиф на основании файловых префиксов, формирующихся при сохранении видео.

Для обеспечения отказоустойчивости используем стандартную master-slave репликацию с 2 репликами master-server.
Master-server будет принимать запросы на запись, реплики - на чтение. 
При выходе из строя master-server, одна из реплик возмет на себя запросы на изменение. 
При выходе из строя всех реплик, запросы будут приходить только на master-server.
