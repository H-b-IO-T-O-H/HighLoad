# HighLoad

The project was developed as part of the Technopark's high-load systems course.

---

### Тема проекта:

Социальная сеть - TikTok.

### Целевая аудитория сервиса:

- Российская аудитория ~ [23.1 млн](https://www.businessofapps.com/data/tik-tok-statistics/#5)

### MVP проекта:

1. Авторизация, регистрация, профиль пользователя;
2. Просмотр видео;
3. Поиск.

### Расчет нагрузки (Россия):

#### Исходные данные ([Источник](https://news.cpa.ru/tiktok-showed-audience-statistics/)):

- Среднее время, которое проводит пользователь в приложении за день: 45 мин;
- Среднее число заходов в приложение за день: 6-7;
- Максимальная длина ролика: 1 минута;
- Минимальная длина ролика: 15 секунд;
- Максимальный размер видео: 75Mb (android), 250Mb (ios);
- 73% используют Android-устройства, а 27% – посещают сервис с iOS;
- Количество лайков видео за день: [54 млн](https://news.cpa.ru/tiktok-showed-audience-statistics/)  
- Число ежедневных просмотров видео: [666 млн](https://news.cpa.ru/tiktok-showed-audience-statistics/);
- Число ежедневных загрузок видео: [666 тыс](https://news.cpa.ru/tiktok-showed-audience-statistics/);
- Активная аудитория России: [18 млн человек](https://news.cpa.ru/tiktok-showed-audience-statistics/);
- Среднее число [хэштегов в видео: 4](https://rusability.ru/articles/Heshtegi-dlya-Tik-Tok-kak-podobrat,-ispolzovat-i-prodvigatsya-bistree-konkurentov/5fd296ad2dda593c3483efc4);
#### Расчеты:

- Средняя длина ролика ~ 30 сек;
- Средний объем выгружаемого на сервер видео-контента: 75 * 0.73 + 250 * 0.27 = 122.25 мб;  
- Дневная аудитория в среднем составляет около ~41% от активной аудитории: 0.41 * 18 * 10 ^ 6 = 7.4 млн;
- Среднее число просмотренных видео за день: 45 мин / 0.5 мин = 90 видео;
- Средний объем видео трафика с сервера для одного
  пользователя: [16 Mb/min](https://www.quora.com/What-uses-more-data-watching-YouTube-videos-for-an-hour-or-TikTok-videos-for-an-hour);
- Средний битрейт видео, загружаемого на сервер, с учетом максимальной продолжительности видео в 60 секунд и его среднего
  объема в 122.25 мб: 122.25 / 60 ~ 16.3 Мбит / сек;
  
Каждое новое видео требует запроса не только к видеофайлу, но и запроса 
бизнес-логики, который позволит получить число лайков, комментариев, подписчиков и прочие вспомогательные данные.
Будем считать, что информация, сопутствующая видео занимает
15% от объема переданного с сервера видео контента, то есть 0.15 * 16 = 2.4 Mb / min.

Так как при загрузке контента сначала появляется информация о видео, то пусть при загрузке одного видео будут 
осуществляться еще 2 запроса бизнес-логики на:
- получение информации о видео (название видео, название аудио, хэштеги, дата, число лайков, число комментариев)
- информация об авторе (никнейм, аватар)

Также в среднем каждые 10 свайпов видео вызывают 1 запрос на получение рекомендаций для пользователя в виде следующих
10 видео. 

Нагрузка для одного пользователя в секунду | Сеть 
--- | ---
Загрузка видео контента | 16 * 8 / 60  = **2.13** Мбит / с
Выгрузка видео контента | (666 000 / (24 * 3600)) / (7.4 * 10 ^ 6 / (24 * 3600)) * 16.3 = **1.3** Мбит / с 
Бизнес-логика | 2.4 * 8/ 60 = **0.32** Мбит / с

Нагрузка дневной аудитории | Сеть 
--- | ---
Загрузка видео контента | 2.13 * 60 * 45 * (7.4 * 10 ^ 6 / (24 * 3600)) = **0.47** Тбит / c
Выгрузка видео контента | 1.3 * 60 * 45 * (7.4 * 10 ^ 6 / (24 * 3600)) = **0.29** Тбит / c
Бизнес-логика | 0.32 * 60 * 45 * (7.4 * 10 ^ 6 / (24 * 3600))  = **0.29** Тбит / c 

Результирующие порядки RPS | RPS
--- | ---
Загрузка видео контента | 666 * 10^6 / (24 * 3600) ~= **7700**
Выгрузка видео контента | 666 * 10^5 / (24 * 3600) ~= **8**
Бизнес-логика | 7700 * 2 + 7700 / 10 ~= **16170**

При это надо учитывать, что число обращений
может увеличиться в [2 раза](https://habr.com/en/company/dcmiran/blog/496542/) при пиковой нагрузке.

### Логическая схема БД:

---
![Иллюстрация к проекту](https://raw.githubusercontent.com/H-b-IO-T-O-H/HighLoad/main/subd_sheme/subd_logic.png)

### Физическая схема БД:

Размер uuid - 16 bytes.

    videos:
      video_id(16) + title(150) + author_name(24) + autor_id(16) + duration(4) + likes_cnt(8) + audio_file_title(50) + path_to_video_file(128) + file_prefix(16) = 412 bytes
      
    Количество загружаемых видео: 20 * 10^6 / month, на первый год потребуется 12 * 20 * 10^6 * 412 ~ 92.1 Gb для хранения в бд 
    и так как средняя длина видео равна 30 секундам, то средний объём одного видео равен 30 * 16.3 / 8 = 61 мб. 
    Тогда на год потребуется 12 * 20 * 10^6 * 61 = 16.3 Мбит / с. ~ 13962 Tb в файловом хранилище
    
    users:
      user_id(16) + name(20) + username(24) + email(128) + phone(11) + password(128) + total_likes_cnt(8) + followers_cnt(8) + following_cnt(8) + recommendation_id(16) = 367 bytes
      Количество пользователей в России: 23.1 * 10^6, потребуется 23.1 * 10^6 * 367 ~ 7.9 Gb
    
    followers:
      follower_id(16) + user_id(16) + follower_name(24) = 56 bytes
      Будем считать только Российский сегмент без подписок на иностранных авторов: 
      потребуется 23.1 * 10^6 * 56 ~ 1.2 Gb
    
    hashtags:
      hashtag_id(16) + hashtag(100) + followers_cnt(8) + is_trend(1) ~ 125 bytes
      В среднем для видео генерируется 4 хэштега. Для Российского сегмента потребуется:
      12 * 20 * 4 * 10^6 * 125 ~ 111 Gb

    recommendations:
      Предположим, рекомендации пользователя определяются на основании 10 последних просмотренных видео и 5 наиболее популярных хэштегов.
      recommendation_id(16) + user_id(16) + favourites_videos_id(16 * 10) +  favourites_hashtags_id(16 * 5) + average_video_duration(4) = 356 bytes
      23.1 * 10^6 * 356 ~ 7.66 Gb

|Сущность|Объем памяти на год работы|
| -------------  | :-------------:  |
|Users|7.9 Гб|
|Recommendations|7.66 Гб|
|Videos|92.1 Гб / 13.63 Пб|
|Hashtags|111 Гб|
|Followers|1.2 Гб|

### Выбор СУБД

Данные пользователей, информацию о видео, подписках и рекоммендациях будут храниться в PostgreSQL, как в хорошо
зарекомендовавшей себя реляционной БД, котарая поддерживает все необходимые средства для ораганизации распределенных
систем. Данные о сессии будут храниться в Redis из-за его высокой скорости работы.

### Шардирование и репликация

- Видео будет распределено на нескольких файловых хранилищах (например HDD) на основании файловых префиксов, формирующихся при сохранении видео.

Для обеспечения отказоустойчивости используем стандартную master-slave репликацию с 2 репликами master-server.
Master-server будет принимать запросы на запись, реплики - на чтение. При выходе из строя master-server, одна из реплик
возмет на себя запросы на изменение. При выходе из строя всех реплик, запросы будут приходить только на master-server.

### Выбор технологий

Бэкенд будет реализован с использованием языка golang, который довольно легок в освоении и из коробки уже содержит
необходимый функционал для поточной обработки соединений. Для снижения нагрузки на бэкенд, повышения отказоустойчивости и 
разделения логики можно использовать микросервисную архитектуру, например с использованием GRPC.

Фронтенд будет написан на React+Mobx+Typescript и реализовывать функционал SPA.Сборка будет реализовываться с использованием
webpack. В качестве балнсировщика нагрузки будет использоваться nginx, который будет проксировать запросы в зависимости от источника
на нужный бэкенд.
